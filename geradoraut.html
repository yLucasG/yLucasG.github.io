<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de RelatÃ³rio (SoluÃ§Ã£o Python Local)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f8f9fa; color: #333; line-height: 1.6; padding: 20px; }
        .container { max-width: 900px; margin: auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1, h2 { color: #0d47a1; border-bottom: 2px solid #e3f2fd; padding-bottom: 10px; }
        label { display: block; margin-top: 15px; font-weight: bold; color: #555; }
        input[type="text"], input[type="date"], textarea {
            width: 100%; padding: 10px; margin-top: 5px; border-radius: 4px; border: 1px solid #ced4da; box-sizing: border-box; background-color: #f1f3f5;
        }
        .file-upload-section { background-color: #e3f2fd; border: 2px dashed #90caf9; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 20px; transition: background-color 0.2s, border-color 0.2s; }
        .file-upload-section.drag-over { background-color: #d1e7fd; border-color: #0d47a1; }
        .file-upload-section label { font-size: 1.2em; color: #0d47a1; cursor: pointer; }
        .file-upload-section input[type="file"] { display: none; }
        #status { margin-top: 10px; font-weight: bold; }
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        button { display: block; width: 100%; padding: 15px; background-color: #1565c0; color: white; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; margin-top: 25px; }
        #resultado { margin-top: 30px; background-color: #212529; color: #f8f9fa; font-family: "Courier New", Courier, monospace; min-height: 400px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Gerador de RelatÃ³rio (SoluÃ§Ã£o Python Local)</h1>
    <p>Arraste e solte o PDF da escala na Ã¡rea azul ou clique para selecionar.</p>

    <div class="file-upload-section" id="dropZone">
        <label for="pdfFile">Arraste e solte o PDF aqui ou clique para selecionar</label>
        <input type="file" id="pdfFile" accept="application/pdf">
        <div id="status">Aguardando IA...</div>
    </div>

    <h2>InformaÃ§Ãµes Gerais</h2>
    <div class="grid-container">
        <div><label for="oficialDia">Oficial de Dia:</label><input type="text" id="oficialDia" value="A PREENCHER"></div>
        <div><label for="dataServico">Data do ServiÃ§o:</label><input type="date" id="dataServico"></div>
        <div><label for="auxiliar">Seu Nome/MatrÃ­cula (Auxiliar):</label><input type="text" id="auxiliar" placeholder="AL CFO PM XXX SEUNOME/PEL/CIA"></div>
        <div><label for="adjunto">Nome/MatrÃ­cula (Adjunto):</label><input type="text" id="adjunto" placeholder="AL CFO PM YYY NOMEADJUNTO/PEL/CIA"></div>
    </div>

    <h2>InformaÃ§Ãµes da Escala (Preenchido pela IA)</h2>
    <label for="plantaoNome">Nome do PlantÃ£o:</label><input type="text" id="plantaoNome" readonly>
    <label for="escalaServico">Escala de PermanÃªncia:</label><textarea id="escalaServico" rows="18"></textarea>
    <label for="alunosServico">Alunos de ServiÃ§o (Ordenados por NÂº):</label><textarea id="alunosServico" rows="15" readonly></textarea>
    <label for="observacoes">ObservaÃ§Ãµes da Escala:</label><textarea id="observacoes" rows="5"></textarea>

    <h2>OcorrÃªncias do Dia (Adicionar Manualmente)</h2>
    <label for="comunicacoes">ğŸ“¢ ComunicaÃ§Ãµes (uma por linha):</label><textarea id="comunicacoes" rows="4"></textarea>
    <label for="passes">ğŸ“œ Passes (uma por linha):</label><textarea id="passes" rows="4"></textarea>
    <label for="instrucoes">ğŸ« InstruÃ§Ã£o Externa (uma por linha):</label><textarea id="instrucoes" rows="4"></textarea>
    <label for="permutas">ğŸ”„ Permutas / AlteraÃ§Ãµes:</label><textarea id="permutas" rows="2" placeholder="Sem alteraÃ§Ãµes."></textarea>

    <button onclick="gerarRelatorio()">Gerar RelatÃ³rio Final</button>

    <h2>Resultado (Clique para selecionar tudo e copiar):</h2>
    <textarea id="resultado" readonly onclick="this.select()"></textarea>

</div>

<script>
    const SERVER_URL = 'http://127.0.0.1:5000/processar-pdf';
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('pdfFile');
    const statusDiv = document.getElementById('status');
    
    // LÃ³gica de arrastar e soltar
    dropZone.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => handleFileSelect(e.target.files[0]));
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        handleFileSelect(e.dataTransfer.files[0]);
    });

    async function handleFileSelect(file) {
        if (!file || file.type !== 'application/pdf') {
            statusDiv.textContent = 'Por favor, selecione um arquivo PDF.';
            statusDiv.style.color = 'red';
            return;
        }

        statusDiv.textContent = `Enviando para a IA... (${file.name})`;
        statusDiv.style.color = '#0d47a1';

        const formData = new FormData();
        formData.append('pdf', file);

        try {
            const response = await fetch(SERVER_URL, { method: 'POST', body: formData });
            const data = await response.json();

            if (!response.ok) { throw new Error(data.erro || 'Erro desconhecido no servidor'); }

            document.getElementById('alunosServico').value = data.alunosServico;
            document.getElementById('escalaServico').value = data.escalaPermanencia;
            document.getElementById('plantaoNome').value = data.plantao;
            document.getElementById('observacoes').value = data.observacoes;

            statusDiv.textContent = 'AnÃ¡lise concluÃ­da com sucesso!';
            statusDiv.style.color = 'green';

        } catch (error) {
            console.error('Erro:', error);
            statusDiv.textContent = `Falha na comunicaÃ§Ã£o com a IA: ${error.message}`;
            statusDiv.style.color = 'red';
        }
    }
    
    // FunÃ§Ãµes de formataÃ§Ã£o e geraÃ§Ã£o do relatÃ³rio final... (cÃ³digo idÃªntico ao anterior)
    function formatarSecao(titulo, conteudo, msgPadrao) {
        if (!conteudo.trim()) return `\n\n${titulo}\n${msgPadrao}`;
        const itens = conteudo.trim().split('\n').map(item => `* ${item}`).join('\n\n');
        return `\n\n${titulo}\n\n${itens}`;
    }
    function gerarRelatorio() {
        const oficialDia = document.getElementById('oficialDia').value;
        const auxiliar = document.getElementById('auxiliar').value;
        const adjunto = document.getElementById('adjunto').value;
        const plantaoNome = document.getElementById('plantaoNome').value.toUpperCase();
        const dataInput = new Date(document.getElementById('dataServico').value + 'T03:00:00Z');
        const dataFim = new Date(dataInput);
        dataFim.setDate(dataInput.getDate() + 1);
        const options = { day: 'numeric', month: 'long', year: 'numeric' };
        const dataInicioFormatada = dataInput.toLocaleDateString('pt-BR', options);
        const dataFimFormatada = dataFim.toLocaleDateString('pt-BR', options);
        const alunosArray = document.getElementById('alunosServico').value.trim().split('\n').filter(Boolean);
        const alunosTexto = alunosArray.join('\n');
        const totalAlunos = alunosArray.length;
        const escala = document.getElementById('escalaServico').value;
        const passes = formatarSecao('ğŸ“œ PASSES', document.getElementById('passes').value, 'Sem alteraÃ§Ãµes.');
        const comunicacoes = formatarSecao('ğŸ“¢ COMUNICAÃ‡Ã•ES', document.getElementById('comunicacoes').value, 'Sem alteraÃ§Ãµes.');
        const instrucoes = formatarSecao('ğŸ« INSTRUÃ‡ÃƒO EXTERNA', document.getElementById('instrucoes').value, 'Sem alteraÃ§Ãµes.');
        const permutas = formatarSecao('ğŸ”„ PERMUTAS / ALTERAÃ‡Ã•ES DO PLANTÃƒO', document.getElementById('permutas').value, 'Sem alteraÃ§Ãµes.');
        const observacoes = formatarSecao('ğŸ“Œ OBSERVAÃ‡Ã•ES', document.getElementById('observacoes').value, 'Sem alteraÃ§Ãµes.');
        const nomeAuxiliar = (auxiliar.split('/')[0] || '').trim();
        const nomeAdjunto = (adjunto.split('/')[0] || '').trim();
        const cidade = "Paudalho - PE";
        const relatorio = `ğŸ”° SDS - PMPE - DGA - DEIP â€“ APMP ğŸ”°\n\nğŸ“Œ RELATÃ“RIO DE PASSAGEM DO SERVIÃ‡O DE AUXILIAR DO OFICIAL DE DIA - 1Âª CIA\n\nğŸ“Œ OFICIAL DE DIA: ${oficialDia}\n\nğŸ“Œ AUXILIAR DO OFICIAL DE DIA: ${auxiliar}\n\nğŸ“Œ ADJUNTO AO AUXILIAR DO OFICIAL DE DIA: ${adjunto}\n\nğŸ—“ï¸ DATA: ${dataInicioFormatada} ao dia ${dataFimFormatada} â° HORÃRIO: 07h00 Ã s 07h00\n\nğŸª– PLANTÃƒO DE SERVIÃ‡O: ${plantaoNome}\n\nğŸ” ALUNOS DE SERVIÃ‡O:\n${alunosTexto}\n\nâ• TOTAL DE SERVIÃ‡O: ${totalAlunos}\n\n${escala.trim()}\n${passes}\n${comunicacoes}\n${instrucoes}\n${permutas}\n${observacoes}\n\n\nğŸ“ ${cidade}, ${dataInicioFormatada}\n\n_________________________\n${nomeAuxiliar}\nAuxiliar do Oficial de Dia - 1Âª CIA\n\n_________________________\n${nomeAdjunto}\nAdjunto ao Auxiliar do Oficial de Dia da 1Âª Companhia\n\n_________________________\nEMANUELA PATRÃCIA SOUZA LINS - MAJ QOPM\nComandante do Corpo de Alunos`;
        document.getElementById('resultado').value = relatorio.trim();
    }
</script>

</body>
</html>