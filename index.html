<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendador de Punições (Versão Offline Definitiva)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #FFFFFF; --bg-secondary: #F4F7FA; --card-bg: #FFFFFF;
            --accent-blue: #004a91; --accent-blue-light: #005cb3; --text-primary: #2D3748;
            --text-secondary: #5A657D; --border-color: #E2E8F0;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-secondary); color: var(--text-primary); }
        .page-container { max-width: 1200px; margin: 40px auto; padding: 20px; }
        h1 { font-size: 2.25rem; margin-bottom: 24px; color: var(--accent-blue); border-bottom: 2px solid var(--accent-blue); padding-bottom: 16px; }
        .card { 
            background-color: var(--card-bg); border-radius: 12px; padding: 24px; 
            margin-bottom: 24px; border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .card h2 { color: var(--accent-blue); font-size: 1.25rem; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        label { display: block; margin-top: 15px; margin-bottom: 5px; font-weight: 500; color: var(--text-secondary); }
        input, textarea, select {
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color);
            box-sizing: border-box; background-color: var(--bg-secondary); color: var(--text-primary);
            font-family: 'Poppins', sans-serif; font-size: 16px; transition: border-color 0.2s, box-shadow 0.2s;
            resize: none; /* <-- CORRIGIDO: Impede redimensionamento */
        }
        input:focus, textarea:focus, select:focus {
            outline: none; border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(0, 74, 145, 0.2);
        }
        .grid-container-2col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .button-primary {
            display: block; width: 100%; padding: 16px; background-color: var(--accent-blue);
            color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: 600; cursor: pointer;
            margin-top: 25px; transition: background-color 0.2s, transform 0.2s;
        }
        .button-primary:hover { background-color: var(--accent-blue-light); transform: translateY(-2px); }
        
        #output-container h3 { font-size: 1.5rem; color: var(--accent-blue); margin-top: 30px; margin-bottom: 15px; }
        .punishment-table {
            width: 100%; border-collapse: collapse; font-size: 0.9em; background-color: var(--bg-primary);
            border-radius: 8px; overflow: hidden; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .punishment-table th, .punishment-table td { padding: 12px 15px; border-bottom: 1px solid var(--border-color); text-align: left; }
        .punishment-table th { background-color: var(--bg-secondary); color: var(--text-secondary); font-weight: 600; }
        .punishment-table tr:last-child td { border-bottom: none; }
        .punishment-table td:nth-child(1) { width: 10%; } /* Data */
        .punishment-table td:nth-child(2) { width: 5%; } /* Nº */
        .punishment-table td:nth-child(3) { width: 15%; } /* Aluno */
        .punishment-table td:nth-child(4) { width: 10%; } /* Plantão */
        .punishment-table td:nth-child(5) { width: 15%; } /* Pelotão */
        .punishment-table td:nth-child(6) { width: 10%; } /* SEI */
        .punishment-table td:nth-child(7) { width: 20%; } /* Resumo */
        .punishment-table td:nth-child(8) { width: 15%; } /* Assinatura */

        #status { text-align: center; font-weight: 500; font-size: 1.1rem; padding: 10px; }
        
        @media (max-width: 900px) { .grid-container-2col { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="page-container">
    <h1>Agendador de Punições (Versão Offline)</h1>

    <div class="card">
        <h2>1. Selecione o Fim de Semana</h2>
        <label for="data_sabado">Selecione o Sábado da Punição:</label>
        <select id="data_sabado">
            <option value="2025-11-08">Sábado, 08 de Novembro de 2025</option>
            <option value="2025-11-15">Sábado, 15 de Novembro de 2025</option>
            <option value="2025-11-22">Sábado, 22 de Novembro de 2025</option>
            <option value="2025-11-29">Sábado, 29 de Novembro de 2025</option>
        </select>
        <p style="color: var(--text-secondary); margin-top: 15px; font-size: 0.9em;">
            O sistema buscará automaticamente quem está de Plantão, Adjunto e Sobreaviso.
        </p>
    </div>
    
    <div class="card">
        <h2>2. Listas Variáveis</h2>
        <div class="grid-container-2col">
            <div>
                <label for="lista_permutas">Alunos em Permuta (Um por linha)</label>
                <textarea id="lista_permutas" rows="10" placeholder="AL CFO PM 01 NOME A..."></textarea>
            </div>
            <div>
                <label for="lista_punidos_tsv">Lista de Punição (Copie da planilha)</label>
                <textarea id="lista_punidos_tsv" rows="10" placeholder="Ex: 34 28/08/2025 83201291 faixa amassada..."></textarea>
                <small style="color: var(--text-secondary);">Cole os dados no formato: Nº (espaço) Data (espaço) SEI (espaço) Resumo</small>
            </div>
        </div>
    </div>

    <button class="button-primary" onclick="agendar()">Agendar Punições</button>
    <div id="status-geral"></div>

    <div class="card">
        <h2>3. Resultado Final (Agenda)</h2>
        <div id="output-container">
            </div>
    </div>
</div>

<script>
    // =========================================================================
    // BANCO DE DADOS MESTRE DE ALUNOS (Embutido no JS)
    // =========================================================================
    const MASTER_ALUNO_DB = {
        1: {"nome": "MÁRCIO SOUZA", "plantao": "FOXTROT", "pelotao": "1º PEL/2ª CIA"},
        2: {"nome": "RENATO", "plantao": "GOLF", "pelotao": "2º PEL/2ª CIA"},
        3: {"nome": "FERNANDO", "plantao": "HOTEL", "pelotao": "1º PEL/2ª CIA"},
        4: {"nome": "ROBERTO FREITAS", "plantao": "INDIA", "pelotao": "4º PEL/2ª CIA"},
        5: {"nome": "SILVANA", "plantao": "FOXTROT", "pelotao": "5º PEL/2ª CIA"},
        6: {"nome": "DANIELLE PRADO", "plantao": "GOLF", "pelotao": "6º PEL/2ª CIA"},
        7: {"nome": "ARCOVERDE", "plantao": "FOXTROT", "pelotao": "1º PEL/2ª CIA"},
        8: {"nome": "AUREA", "plantao": "HOTEL", "pelotao": "1º PEL/2ª CIA"},
        9: {"nome": "R. FERREIRA", "plantao": "GOLF", "pelotao": "1º PEL/2ª CIA"},
        10: {"nome": "VICTOR FERREIRA", "plantao": "HOTEL", "pelotao": "2º PEL/2ª CIA"},
        11: {"nome": "ORLANDO", "plantao": "INDIA", "pelotao": "2º PEL/2ª CIA"},
        12: {"nome": "ISABELLA", "plantao": "INDIA", "pelotao": "2º PEL/2ª CIA"},
        13: {"nome": "BRENDA", "plantao": "FOXTROT", "pelotao": "1º PEL/2ª CIA"},
        14: {"nome": "AMANDA COELHO", "plantao": "GOLF", "pelotao": "4º PEL/2ª CIA"},
        15: {"nome": "JUNIOR", "plantao": "GOLF", "pelotao": "3º PEL/2ª CIA"},
        16: {"nome": "EMILY", "plantao": "FOXTROT", "pelotao": "1º PEL/1ª CIA"},
        17: {"nome": "MURILO", "plantao": "HOTEL", "pelotao": "5º PEL/2ª CIA"},
        18: {"nome": "ARYANA", "plantao": "HOTEL", "pelotao": "1º PEL/2ª CIA"},
        19: {"nome": "ALENCAR", "plantao": "INDIA", "pelotao": "3º PEL/2ª CIA"},
        20: {"nome": "LUAN PEREIRA", "plantao": "GOLF", "pelotao": "4º PEL/2ª CIA"},
        21: {"nome": "MANOEL", "plantao": "FOXTROT", "pelotao": "2º PEL/2ª CIA"},
        24: {"nome": "MATHEUS MESQUITA", "plantao": "GOLF", "pelotao": "2º PEL/2ª CIA"},
        25: {"nome": "DAVI OLIVEIRA", "plantao": "FOXTROT", "pelotao": "3º PEL/2ª CIA"},
        26: {"nome": "MARCOLINO", "plantao": "INDIA", "pelotao": "4º PEL/2ª CIA"},
        27: {"nome": "FATIMA AGUIAR", "plantao": "INDIA", "pelotao": "6º PEL/2ª CIA"},
        28: {"nome": "LEMOS", "plantao": "HOTEL", "pelotao": "1º PEL/2ª CIA"},
        29: {"nome": "MACIEL", "plantao": "INDIA", "pelotao": "6º PEL/2ª CIA"},
        30: {"nome": "M ALBUQUERQUE", "plantao": "GOLF", "pelotao": "2º PEL/2ª CIA"},
        31: {"nome": "ALLATAS SOUSA", "plantao": "HOTEL", "pelotao": "3º PEL/2ª CIA"},
        32: {"nome": "KAYO GABRIEL", "plantao": "HOTEL", "pelotao": "1º PEL/2ª CIA"},
        33: {"nome": "KAROLINE ABREU", "plantao": "GOLF", "pelotao": "1º PEL/2ª CIA"},
        34: {"nome": "GIOVANNI", "plantao": "FOXTROT", "pelotao": "1º PEL/2ª CIA"},
        35: {"nome": "PAULINO", "plantao": "GOLF", "pelotao": "6º PEL/2ª CIA"},
        36: {"nome": "M. FEITOSA", "plantao": "HOTEL", "pelotao": "1º PEL/2ª CIA"},
        37: {"nome": "VALDECI", "plantao": "FOXTROT", "pelotao": "6º PEL/2ª CIA"},
        38: {"nome": "W. SILVA", "plantao": "FOXTROT", "pelotao": "3º PEL/2ª CIA"},
        39: {"nome": "ELLIO", "plantao": "GOLF", "pelotao": "2º PEL/2ª CIA"},
        40: {"nome": "MARINHO", "plantao": "HOTEL", "pelotao": "3º PEL/2ª CIA"},
        41: {"nome": "MALAQUIAS", "plantao": "INDIA", "pelotao": "4º PEL/2ª CIA"},
        42: {"nome": "CARLA ARAUJO", "plantao": "FOXTROT", "pelotao": "2º PEL/2ª CIA"},
        43: {"nome": "CINTIA SOUZA", "plantao": "HOTEL", "pelotao": "3º PEL/2ª CIA"},
        44: {"nome": "PRISCILA CORREIA", "plantao": "INDIA", "pelotao": "4º PEL/2ª CIA"},
        45: {"nome": "WALYSON", "plantao": "FOXTROT", "pelotao": "5º PEL/2ª CIA"},
        46: {"nome": "GRANGEIRO", "plantao": "GOLF", "pelotao": "3º PEL/2ª CIA"},
        47: {"nome": "MACEDO", "plantao": "HOTEL", "pelotao": "4º PEL/2ª CIA"},
        48: {"nome": "ELVIS", "plantao": "INDIA", "pelotao": "5º PEL/2ª CIA"},
        49: {"nome": "JEFFERSON SILVA", "plantao": "FOXTROT", "pelotao": "1º PEL/2ª CIA"},
        50: {"nome": "QUEIROZ", "plantao": "GOLF", "pelotao": "6º PEL/2ª CIA"},
        52: {"nome": "RUBSLEY", "plantao": "INDIA", "pelotao": "2º PEL/2ª CIA"},
        53: {"nome": "G. SILVA", "plantao": "FOXTROT", "pelotao": "1º PEL/2ª CIA"},
        54: {"nome": "FRANÇA", "plantao": "GOLF", "pelotao": "1º PEL/2ª CIA"},
        57: {"nome": "SANTANA", "plantao": "INDIA", "pelotao": "2º PEL/2ª CIA"},
        58: {"nome": "WESLEY", "plantao": "FOXTROT", "pelotao": "5º PEL/2ª CIA"},
        59: {"nome": "RAYANNE", "plantao": "GOLF", "pelotao": "6º PEL/2ª CIA"},
        60: {"nome": "S.GOMES", "plantao": "GOLF", "pelotao": "6º PEL/2ª CIA"},
        61: {"nome": "FIRMINO", "plantao": "INDIA", "pelotao": "4º PEL/2ª CIA"},
        62: {"nome": "LUCAS MAGALHÃES", "plantao": "INDIA", "pelotao": "5º PEL/2ª CIA"},
        63: {"nome": "PAULO", "plantao": "FOXTROT", "pelotao": "1º PEL/2ª CIA"},
        64: {"nome": "BONFIM", "plantao": "GOLF", "pelotao": "6º PEL/2ª CIA"},
        66: {"nome": "JONATAS SANTOS", "plantao": "HOTEL", "pelotao": "2º PEL/2ª CIA"},
        67: {"nome": "LAYANNE", "plantao": "FOXTROT", "pelotao": "1º PEL/2ª CIA"},
        68: {"nome": "KAROLINNE MOREIRA", "plantao": "INDIA", "pelotao": "2º PEL/2ª CIA"},
        69: {"nome": "FALCÃO", "plantao": "FOXTROT", "pelotao": "3º PEL/2ª CIA"},
        70: {"nome": "MEIRA", "plantao": "HOTEL", "pelotao": "1º PEL/2ª CIA"},
        71: {"nome": "SERAFIM", "plantao": "GOLF", "pelotao": "4º PEL/2ª CIA"},
        72: {"nome": "NONATO", "plantao": "INDIA", "pelotao": "5º PEL/2ª CIA"},
        73: {"nome": "PEREIRA", "plantao": "FOXTROT", "pelotao": "2º PEL/2ª CIA"},
        74: {"nome": "GABRIEL", "plantao": "GOLF", "pelotao": "6º PEL/2ª CIA"},
        75: {"nome": "PEDRO", "plantao": "HOTEL", "pelotao": "3º PEL/2ª CIA"},
        76: {"nome": "FERREIRA", "plantao": "INDIA", "pelotao": "4º PEL/2ª CIA"},
        77: {"nome": "EDUARDA", "plantao": "HOTEL", "pelotao": "3º PEL/2ª CIA"},
        78: {"nome": "GISELE FERREIRA", "plantao": "GOLF", "pelotao": "4º PEL/2ª CIA"},
        79: {"nome": "DIOGENES", "plantao": "FOXTROT", "pelotao": "4º PEL/2ª CIA"},
        80: {"nome": "JOSE", "plantao": "GOLF", "pelotao": "5º PEL/2ª CIA"},
        81: {"nome": "COSTA", "plantao": "HOTEL", "pelotao": "1º PEL/2ª CIA"},
        82: {"nome": "MARCOS NASCIMENTO", "plantao": "INDIA", "pelotao": "1º PEL/2ª CIA"},
        83: {"nome": "P. SOUZA", "plantao": "FOXTROT", "pelotao": "2º PEL/2ª CIA"},
        84: {"nome": "SIDNEI ARAÚJO", "plantao": "GOLF", "pelotao": "3º PEL/2ª CIA"},
        85: {"nome": "ANDERSON", "plantao": "HOTEL", "pelotao": "4º PEL/2ª CIA"},
        86: {"nome": "FERNANDO CRUZ", "plantao": "INDIA", "pelotao": "5º PEL/2ª CIA"},
        87: {"nome": "ARYCLAYTON", "plantao": "FOXTROT", "pelotao": "1º PEL/2ª CIA"},
        88: {"nome": "S. NETO", "plantao": "GOLF", "pelotao": "1º PEL/2ª CIA"},
        89: {"nome": "SILVA", "plantao": "HOTEL", "pelotao": "1º PEL/2ª CIA"},
        90: {"nome": "RAFAEL BEZERRA", "plantao": "INDIA", "pelotao": "3º PEL/2ª CIA"},
        91: {"nome": "GESSICA", "plantao": "FOXTROT", "pelotao": "5º PEL/2ª CIA"},
        92: {"nome": "ALINE", "plantao": "INDIA", "pelotao": "6º PEL/2ª CIA"},
        93: {"nome": "REVERTHON", "plantao": "FOXTROT", "pelotao": "1º PEL/2ª CIA"},
        94: {"nome": "FERNANDA SOARES", "plantao": "HOTEL", "pelotao": "1º PEL/2ª CIA"},
        95: {"nome": "BRUNO", "plantao": "INDIA", "pelotao": "5º PEL/2ª CIA"},
        96: {"nome": "ERIVELTON", "plantao": "HOTEL", "pelotao": "2º PEL/2ª CIA"},
        97: {"nome": "ITALO", "plantao": "INDIA", "pelotao": "3º PEL/2ª CIA"},
        98: {"nome": "EMANNUEL", "plantao": "FOXTROT", "pelotao": "4º PEL/2ª CIA"},
        99: {"nome": "G. GOMES", "plantao": "GOLF", "pelotao": "4º PEL/2ª CIA"},
        100: {"nome": "RENAN", "plantao": "INDIA", "pelotao": "6º PEL/2ª CIA"},
        101: {"nome": "SELTON", "plantao": "FOXTROT", "pelotao": "1D PEL/2ª CIA"},
        102: {"nome": "ALLAN MARIANO", "plantao": "FOXTROT", "pelotao": "5º PEL/2ª CIA"},
        103: {"nome": "RAISSA SOARES", "plantao": "FOXTROT", "pelotao": "2º PEL/2ª CIA"},
        105: {"nome": "JOSÉ NETO", "plantao": "GOLF", "pelotao": "5º PEL/2ª CIA"},
        106: {"nome": "LUCAS RANIELLE", "plantao": "HOTEL", "pelotao": "3º PEL/2ª CIA"},
        107: {"nome": "LUCIANO", "plantao": "HOTEL", "pelotao": "1º PEL/2ª CIA"},
        108: {"nome": "HENRIQUE", "plantao": "GOLF", "pelotao": "1º PEL/2ª CIA"},
        109: {"nome": "ERIKA DUARTE", "plantao": "HOTEL", "pelotao": "4º PEL/2ª CIA"},
        110: {"nome": "CÉSAR MEDEIROS", "plantao": "FOXTROT", "pelotao": "1º PEL/2ª CIA"},
        111: {"nome": "FELIPE MORAIS", "plantao": "HOTEL", "pelotao": "2º PEL/2ª CIA"},
        112: {"nome": "MARQUES", "plantao": "INDIA", "pelotao": "3º PEL/2ª CIA"},
        113: {"nome": "AURÉLIO", "plantao": "GOLF", "pelotao": "4º PEL/2ª CIA"},
        114: {"nome": "BARBALHO", "plantao": "FOXTROT", "pelotao": "5º PEL/2ª CIA"},
        115: {"nome": "VINICIUS OLIVEIRA", "plantao": "HOTEL", "pelotao": "1º PEL/2ª CIA"},
        116: {"nome": "SANTIAGO", "plantao": "INDIA", "pelotao": "6º PEL/2ª CIA"},
        118: {"nome": "DURVAL", "plantao": "FOXTROT", "pelotao": "1º PEL/2ª CIA"},
        119: {"nome": "VINÍCIUS SOUZA", "plantao": "GOLF", "pelotao": "2º PEL/2ª CIA"},
        120: {"nome": "EGITO", "plantao": "INDIA", "pelotao": "3º PEL/2ª CIA"},
        121: {"nome": "JOÃO NASCIMENTO", "plantao": "INDIA", "pelotao": "2º PEL/2ª CIA"},
        122: {"nome": "BATISTA", "plantao": "FOXTROT", "pelotao": "4º PEL/2ª CIA"},
        123: {"nome": "GONZAGA", "plantao": "GOLF", "pelotao": "5º PEL/2ª CIA"},
        125: {"nome": "MEDEIROS", "plantao": "HOTEL", "pelotao": "1º PEL/2ª CIA"},
        126: {"nome": "GILMARA", "plantao": "INDIA", "pelotao": "5º PEL/2ª CIA"},
        127: {"nome": "CAIO GUIMARAES", "plantao": "HOTEL", "pelotao": "1º PEL/2ª CIA"},
        128: {"nome": "ALEXANDRO GOMES", "plantao": "FOXTROT", "pelotao": "4º PEL/2ª CIA"},
        129: {"nome": "LUIZ NUNES", "plantao": "GOLF", "pelotao": "5º PEL/2ª CIA"},
        130: {"nome": "PAULO ROBERTO", "plantao": "INDIA", "pelotao": "6º PEL/2ª CIA"},
        131: {"nome": "RENATA", "plantao": "FOXTROT", "pelotao": "1º PEL/2ª CIA"},
        132: {"nome": "SERGIO", "plantao": "INDIA", "pelotao": "1º PEL/2ª CIA"},
        133: {"nome": "ISRAEL", "plantao": "FOXTROT", "pelotao": "2º PEL/2ª CIA"},
        134: {"nome": "SAMEA FERRAZ", "plantao": "GOLF", "pelotao": "2º PEL/2ª CIA"},
        135: {"nome": "JOÃO HENRIQUE", "plantao": "GOLF", "pelotao": "3º PEL/2ª CIA"},
        136: {"nome": "PATRICIA", "plantao": "HOTEL", "pelotao": "1º PEL/2ª CIA"},
        137: {"nome": "RAFAEL PEREIRA", "plantao": "HOTEL", "pelotao": "1º PEL/2ª CIA"},
        138: {"nome": "ICARO", "plantao": "HOTEL", "pelotao": "5º PEL/2ª CIA"},
        139: {"nome": "JULIANA GONDIM", "plantao": "INDIA", "pelotao": "3º PEL/2ª CIA"},
        140: {"nome": "VICTOR COSTA", "plantao": "FOXTROT", "pelotao": "1º PEL/2ª CIA"},
        141: {"nome": "JULIANE CORDEIRO", "plantao": "FOXTROT", "pelotao": "4º PEL/2ª CIA"},
        142: {"nome": "JABNER", "plantao": "GOLF", "pelotao": "2º PEL/2ª CIA"},
        143: {"nome": "SAMARA MELO", "plantao": "GOLF", "pelotao": "5º PEL/2ª CIA"},
        144: {"nome": "EDJANE", "plantao": "HOTEL", "pelotao": "1D PEL/2ª CIA"},
        145: {"nome": "HIGOR ALVES", "plantao": "INDIA", "pelotao": "5º PEL/2ª CIA"},
        146: {"nome": "PEREIRA MORAIS", "plantao": "INDIA", "pelotao": "6º PEL/2ª CIA"},
        147: {"nome": "JORGE FILHO", "plantao": "FOXTROT", "pelotao": "1º PEL/2ª CIA"},
        148: {"nome": "OLAVO", "plantao": "INDIA", "pelotao": "3º PEL/2ª CIA"},
        149: {"nome": "CAVALCANTI", "plantao": "HOTEL", "pelotao": "1º PEL/2ª CIA"},
        150: {"nome": "ROBERTA", "plantao": "INDIA", "pelotao": "1º PEL/2ª CIA"},
        151: {"nome": "OLIVEIRA JUNIOR", "plantao": "HOTEL", "pelotao": "3º PEL/2ª CIA"},
        152: {"nome": "MOURA", "plantao": "GOLF", "pelotao": "2º PEL/2ª CIA"},
        153: {"nome": "AFONSO", "plantao": "FOXTROT", "pelotao": "1º PEL/2ª CIA"},
        154: {"nome": "DAYANE", "plantao": "FOXTROT", "pelotao": "2º PEL/2ª CIA"},
        156: {"nome": "MONALIZA", "plantao": "GOLF", "pelotao": "3º PEL/2ª CIA"},
        157: {"nome": "VALADARES", "plantao": "INDIA", "pelotao": "3º PEL/2ª CIA"},
        158: {"nome": "HEYVERSON", "plantao": "FOXTROT", "pelotao": "1º PEL/2ª CIA"},
        161: {"nome": "JOSE ALISSON", "plantao": "GOLF", "pelotao": "6º PEL/2ª CIA"},
        162: {"nome": "JESUS", "plantao": "HOTEL", "pelotao": "1D PEL/2ª CIA"},
        163: {"nome": "NATALIA", "plantao": "INDIA", "pelotao": "5º PEL/2ª CIA"},
        164: {"nome": "CIBELE", "plantao": "FOXTROT", "pelotao": "6º PEL/2ª CIA"},
        165: {"nome": "GUSTAVO", "plantao": "GOLF", "pelotao": "2º PEL/2ª CIA"},
        166: {"nome": "FELIPE FELIX", "plantao": "FOXTROT", "pelotao": "5º PEL/2ª CIA"},
        168: {"nome": "LEONAM", "plantao": "GOLF", "pelotao": "5º PEL/2ª CIA"},
        169: {"nome": "MATHEUS BARROS", "plantao": "INDIA", "pelotao": "6º PEL/2ª CIA"},
        170: {"nome": "ANTONIO REIS", "plantao": "FOXTROT", "pelotao": "4º PEL/2ª CIA"},
        171: {"nome": "JHONEY", "plantao": "HOTEL", "pelotao": "3º PEL/2ª CIA"},
        172: {"nome": "FRANCISCO", "plantao": "GOLF", "pelotao": "1º PEL/2ª CIA"},
        173: {"nome": "IURY", "plantao": "INDIA", "pelotao": "3º PEL/2ª CIA"},
        174: {"nome": "LIMA PAIVA", "plantao": "FOXTROT", "pelotao": "1Multi-select"},
        175: {"nome": "LUIZ LEAL", "plantao": "HOTEL", "pelotao": "1º PEL/2ª CIA"},
        176: {"nome": "RHAYSA", "plantao": "INDIA", "pelotao": "1º PEL/2ª CIA"},
        177: {"nome": "DIONIZIO", "plantao": "HOTEL", "pelotao": "4º PEL/2ª CIA"},
        178: {"nome": "HIAGO", "plantao": "INDIA", "pelotao": "4º PEL/2ª CIA"},
        179: {"nome": "DEBORA GOUVEIA", "plantao": "HOTEL", "pelotao": "2º PEL/2ª CIA"},
        180: {"nome": "NOBREGA", "plantao": "GOLF", "pelotao": "5º PEL/2ª CIA"},
        181: {"nome": "THAYNARA", "plantao": "GOLF", "pelotao": "3º PEL/2ª CIA"},
        182: {"nome": "JOSINALDO", "plantao": "FOXTROT", "pelotao": "4º PEL/2ª CIA"},
        183: {"nome": "JULIO", "plantao": "HOTEL", "pelotao": "5º PEL/2ª CIA"},
        184: {"nome": "ABRAÃO", "plantao": "HOTEL", "pelotao": "1º PEL/2ª CIA"},
        185: {"nome": "RONILSON", "plantao": "HOTEL", "pelotao": "1º PEL/2ª CIA"},
        186: {"nome": "SOUTO", "plantao": "INDIA", "pelotao": "3º PEL/2ª CIA"},
        187: {"nome": "BELEM", "plantao": "HOTEL", "pelotao": "4º PEL/2ª CIA"},
        188: {"nome": "MAXEMBERG", "plantao": "INDIA", "pelotao": "3º PEL/2ª CIA"},
        189: {"nome": "KAMYLA", "plantao": "HOTEL", "pelotao": "1º PEL/2ª CIA"},
        190: {"nome": "JÚLIA", "plantao": "GOLF", "pelotao": "5º PEL/2ª CIA"},
        191: {"nome": "SELTON", "plantao": "FOXTROT", "pelotao": "4º PEL/2ª CIA"},
        192: {"nome": "JEFFERSON GOMES", "plantao": "GOLF", "pelotao": "1º PEL/2ª CIA"},
        193: {"nome": "JAILTON", "plantao": "HOTEL", "pelotao": "3º PEL/2ª CIA"},
        194: {"nome": "KLEVER", "plantao": "INDIA", "pelotao": "5º PEL/2ª CIA"},
        195: {"nome": "PETTERSON", "plantao": "INDIA", "pelotao": "2º PEL/2ª CIA"},
        196: {"nome": "CARDOSO", "plantao": "GOLF", "pelotao": "6º PEL/2ª CIA"},
        197: {"nome": "ISRAEL OLIVEIRA", "plantao": "HOTEL", "pelotao": "4º PEL/2ª CIA"},
    };

    function formatarNomeAluno(num, nome) {
        return `AL CFO PM ${String(num).padStart(2, '0')} ${nome.trim().toUpperCase()}`;
    }

    // Preenche as listas de plantão a partir do DB Mestre
    const LISTAS_PLANTOES = { "NENHUM": new Set() };
    for (const [num, info] of Object.entries(MASTER_ALUNO_DB)) {
        const plantao = info.plantao;
        const full_name = formatarNomeAluno(num, info.nome);
        info.full_name = full_name; // Adiciona o nome formatado ao DB
        if (!LISTAS_PLANTOES[plantao]) LISTAS_PLANTOES[plantao] = new Set();
        LISTAS_PLANTOES[plantao].add(full_name);
    }

    // =========================================================================
    // CALENDÁRIO DE SERVIÇO DE FIM DE SEMANA (COMPLETO)
    // =========================================================================
    const CALENDARIO_SERVICO = {
        "2025-11-07": { // SEXTA
            "plantao": LISTAS_PLANTOES.INDIA,
            "adjunto": new Set([formatarNomeAluno(42, "CARLA ARAÚJO"), formatarNomeAluno(140, "VICTOR COSTA")]),
            "sobreaviso": new Set([
                formatarNomeAluno(141, "JULIANE CORDEIRO"), formatarNomeAluno(128, "ALEXANDRO GOMES"), formatarNomeAluno(122, "BATISTA"), formatarNomeAluno(118, "DURVAL"),
                formatarNomeAluno(114, "BARBALHO"), formatarNomeAluno(110, "CÉSAR MEDEIROS"), formatarNomeAluno(102, "ALLAN MARIANO")
            ])
        },
        "2025-11-08": { // SÁBADO
            "plantao": LISTAS_PLANTOES.GOLF,
            "adjunto": new Set([formatarNomeAluno(45, "WALYSON"), formatarNomeAluno(133, "ISRAEL")]),
            "sobreaviso": new Set([
                formatarNomeAluno(67, "LAYANNE"), formatarNomeAluno(63, "PAULO"), formatarNomeAluno(38, "W. SILVA"), formatarNomeAluno(37, "VALDECI"),
                formatarNomeAluno(58, "WESLEY"), formatarNomeAluno(53, "G. SILVA"), formatarNomeAluno(49, "JEFFERSON SILVA")
            ])
        },
        "2025-11-09": { // DOMINGO
            "plantao": LISTAS_PLANTOES.HOTEL,
            "adjunto": new Set([formatarNomeAluno(48, "ELVIS"), formatarNomeAluno(146, "PEREIRA MORAIS")]),
            "sobreaviso": new Set([
                formatarNomeAluno(132, "SERGIO"), formatarNomeAluno(120, "EGITO"), formatarNomeAluno(100, "RENAN"), formatarNomeAluno(26, "MARCOLINO"),
                formatarNomeAluno(12, "ISABELLA"), formatarNomeAluno(11, "ORLANDO"), formatarNomeAluno(4, "ROBERTO FREITAS")
            ])
        },
        "2025-11-14": { // SEXTA
            "plantao": LISTAS_PLANTOES.HOTEL,
            "adjunto": new Set([formatarNomeAluno(74, "GABRIEL"), formatarNomeAluno(99, "G. GOMES")]),
            "sobreaviso": new Set([
                formatarNomeAluno(156, "MONALIZA"), formatarNomeAluno(152, "MOURA"), formatarNomeAluno(143, "SAMARA MELO"), formatarNomeAluno(15, "JUNIOR"),
                formatarNomeAluno(14, "AMANDA COELHO"), formatarNomeAluno(9, "R. FERREIRA"), formatarNomeAluno(2, "RENATO")
            ])
        },
        "2025-11-15": { // SÁBADO
            "plantao": LISTAS_PLANTOES.INDIA,
            "adjunto": new Set([formatarNomeAluno(78, "GISELE FERREIRA"), formatarNomeAluno(84, "SIDNEI ARAÚJO")]),
            "sobreaviso": new Set([
                formatarNomeAluno(68, "KAROLINNE MOREIRA"), formatarNomeAluno(61, "FIRMINO"), formatarNomeAluno(48, "ELVIS"), formatarNomeAluno(44, "PRISCILA CORREIA"),
                formatarNomeAluno(41, "MALAQUIAS"), formatarNomeAluno(29, "MACIEL"), formatarNomeAluno(27, "FATIMA AGUIAR")
            ])
        },
        "2025-11-16": { // DOMINGO
            "plantao": LISTAS_PLANTOES.FOXTROT,
            "adjunto": new Set([formatarNomeAluno(75, "PEDRO"), formatarNomeAluno(138, "ICARO")]),
            "sobreaviso": new Set([
                formatarNomeAluno(77, "EDUARDA"), formatarNomeAluno(66, "JONATAS SANTOS"), formatarNomeAluno(47, "MACEDO"), formatarNomeAluno(43, "CINTIA SOUZA"),
                formatarNomeAluno(40, "MARINHO"), formatarNomeAluno(31, "ALLATAS SOUSA"), formatarNomeAluno(28, "LEMOS")
            ])
        },
        "2025-11-21": { // SEXTA
            "plantao": LISTAS_PLANTOES.FOXTROT,
            "adjunto": new Set([formatarNomeAluno(61, "FIRMINO"), formatarNomeAluno(139, "JULIANA GONDIM")]),
            "sobreaviso": new Set([
                formatarNomeAluno(169, "MATHEUS BARROS"), formatarNomeAluno(148, "OLAVO"), formatarNomeAluno(130, "PAULO ROBERTO"), formatarNomeAluno(126, "GILMARA"),
                formatarNomeAluno(121, "JOÃO NASCIMENTO"), formatarNomeAluno(116, "SANTIAGO"), formatarNomeAluno(97, "ITALO")
            ])
        },
        "2025-11-22": { // SÁBADO
            "plantao": LISTAS_PLANTOES.HOTEL,
            "adjunto": new Set([formatarNomeAluno(60, "S.GOMES"), formatarNomeAluno(196, "CARDOSO")]),
            "sobreaviso": new Set([
                formatarNomeAluno(192, "JEFFERSON GOMES"), formatarNomeAluno(181, "THAYNARA"), formatarNomeAluno(172, "FRANCISCO"),
                formatarNomeAluno(168, "LEONAM"), formatarNomeAluno(105, "JOSÉ NETO")
            ])
        },
        "2025-11-23": { // DOMINGO
            "plantao": LISTAS_PLANTOES.INDIA,
            "adjunto": new Set([formatarNomeAluno(58, "WESLEY"), formatarNomeAluno(118, "DURVAL")]),
            "sobreaviso": new Set([
                formatarNomeAluno(24, "MATHEUS MESQUITA"), formatarNomeAluno(20, "LUAN PEREIRA"), formatarNomeAluno(69, "FALCÃO"), formatarNomeAluno(45, "WALYSON"),
                formatarNomeAluno(42, "CARLA ARAUJO"), formatarNomeAluno(16, "EMILY"),
                formatarNomeAluno(7, "ARCOVERDE"), formatarNomeAluno(5, "SILVANA"),
                formatarNomeAluno(1, "MÁRCIO SOUZA")
            ])
        },
        "2025-11-28": { // SEXTA
            "plantao": LISTAS_PLANTOES.HOTEL,
            "adjunto": new Set([formatarNomeAluno(67, "LAYANNE"), formatarNomeAluno(110, "CÉSAR MEDEIROS")]),
            "sobreaviso": new Set([
                formatarNomeAluno(191, "SELTON"), formatarNomeAluno(182, "JOSINALDO"), formatarNomeAluno(170, "ANTONIO REIS"), formatarNomeAluno(166, "FELIPE FELIX"),
                formatarNomeAluno(164, "CIBELE"), formatarNomeAluno(158, "HEYVERSON"), formatarNomeAluno(154, "DAYANE")
            ])
        },
        "2025-11-29": { // SÁBADO
            "plantao": LISTAS_PLANTOES.GOLF,
            "adjunto": new Set([formatarNomeAluno(82, "MARCOS NASCIMENTO"), formatarNomeAluno(120, "EGITO")]),
            "sobreaviso": new Set([
                formatarNomeAluno(95, "BRUNO"), formatarNomeAluno(97, "ITALO"), formatarNomeAluno(52, "RUBSLEY"), formatarNomeAluno(62, "LUCAS MAGALHÃES"),
                formatarNomeAluno(72, "NONATO"), formatarNomeAluno(112, "MARQUES"), formatarNomeAluno(121, "JOÃO NASCIMENTO")
            ])
        },
        "2025-11-30": { // DOMINGO
            "plantao": LISTAS_PLANTOES.FOXTROT,
            "adjunto": new Set([formatarNomeAluno(92, "ALINE"), formatarNomeAluno(116, "SANTIAGO")]),
            "sobreaviso": new Set([
                formatarNomeAluno(195, "PETTERSON"), formatarNomeAluno(194, "KLEVER"), formatarNomeAluno(188, "MAXEMBERG"), formatarNomeAluno(186, "SOUTO"),
                formatarNomeAluno(178, "HIAGO"), formatarNomeAluno(176, "RHAYSA"), formatarNomeAluno(173, "IURY")
            ])
        },
    };

    // =========================================================================
    // LÓGICA DO AGENDADOR
    // =========================================================================
    const statusGeral = document.getElementById('status-geral');
    const outputContainer = document.getElementById('output-container');

    // --- Função Auxiliar: Formatar Data (JS) ---
    function formatarDataJS(data) { // Formato YYYY-MM-DD
        const [ano, mes, dia] = data.split('-');
        const dataObj = new Date(ano, mes - 1, dia);
        return {
            sex: new Date(dataObj.setDate(dataObj.getDate() - 1)).toISOString().split('T')[0],
            sab: data,
            dom: new Date(dataObj.setDate(dataObj.getDate() + 2)).toISOString().split('T')[0]
        };
    }

    // --- Função Auxiliar: Parsear Lista TSV ---
    function extrairPunidosDoTSV(tsv_string) {
        let punicoes = [];
        const linhas = tsv_string.trim().split('\n');
        const padrao_flexivel = /^\s*(\d{1,3})\s+([\d/]{8,10})\s+(\d{8,})\s+(.+)$/;
        
        for (const linha of linhas) {
            if (!linha.trim()) continue;
            
            const match = linha.trim().match(padrao_flexivel);
            if (!match) {
                console.warn("Linha TSV não reconhecida, pulando:", linha);
                continue;
            }
            
            const [, num_str, data_rel, sei, resumo] = match;
            const numero = parseInt(num_str, 10);
            const alunoInfo = MASTER_ALUNO_DB[numero];
            
            if (!alunoInfo) {
                console.warn(`Aluno com Nº ${numero} não encontrado no DB Mestre.`);
                continue;
            }
            
            punicoes.push({
                n: String(numero).padStart(2, '0'),
                aluno: alunoInfo.nome,
                plantao: alunoInfo.plantao,
                pelotao: alunoInfo.pelotao,
                data_relatorio: data_rel.trim(),
                sei: sei.trim(),
                resumo: resumo.trim(),
                full_name: alunoInfo.full_name
            });
        }
        return punicoes;
    }

    // --- Função Principal de Agendamento ---
    function agendar() {
        statusGeral.textContent = 'Agendando...';
        statusGeral.style.color = 'var(--accent-blue-light)';
        outputContainer.innerHTML = '';

        try {
            const data_sabado_str = document.getElementById('data_sabado').value;
            const lista_permutas_bruta = document.getElementById('lista_permutas').value;
            const lista_punidos_tsv = document.getElementById('lista_punidos_tsv').value;

            if (!lista_punidos_tsv.trim()) {
                throw new Error("A lista de punição está vazia. Cole os dados da planilha.");
            }

            const punicoes = extrairPunidosDoTSV(lista_punidos_tsv);
            if (punicoes.length === 0) {
                 throw new Error("Nenhuma punição válida foi extraída. Verifique o formato: Nº DATA SEI RESUMO");
            }
            
            const lista_permutas = new Set(lista_permutas_bruta.trim().split('\n').filter(Boolean).map(n => n.trim()));
            
            const datas = formatarDataJS(data_sabado_str);
            
            const servico_sex = CALENDARIO_SERVICO[datas.sex] || {};
            const servico_sab = CALENDARIO_SERVICO[datas.sab] || {};
            const servico_dom = CALENDARIO_SERVICO[datas.dom] || {};

            if (!servico_sex.plantao || !servico_sab.plantao || !servico_dom.plantao) {
                throw new Error(`Calendário de serviço não encontrado para a data base ${datas.sab}. Verifique o Banco de Dados.`);
            }

            const excecoes_sex = new Set([...servico_sex.plantao, ...servico_sex.adjunto, ...servico_sex.sobreaviso]);
            const excecoes_sab = new Set([...servico_sab.plantao, ...servico_sab.adjunto, ...servico_sab.sobreaviso]);
            const excecoes_dom = new Set([...servico_dom.plantao, ...servico_dom.adjunto, ...servico_dom.sobreaviso]);

            const horarios = ["Sábado (Manhã)", "Sábado (Tarde)", "Domingo (Manhã)", "Domingo (Tarde)"];
            let agenda_final = {
                "Sábado (Manhã)": [],
                "Sábado (Tarde)": [],
                "Domingo (Manhã)": [],
                "Domingo (Tarde)": [],
                "Próximo Fim de Semana": []
            };
            let removidos = {"PERMUTA": []};
            
            let horario_index = 0;
            let punicoes_agendadas_neste_fds = 0;
            
            punicoes.sort((a, b) => parseInt(a.n) - parseInt(b.n)); // Ordena por antiguidade
            
            for (const punicao of punicoes) {
                const aluno_full_name = punicao.full_name;

                if (lista_permutas.has(aluno_full_name)) {
                    removidos["PERMUTA"].push(aluno_full_name);
                    continue;
                }
                
                let horarios_disponiveis_aluno = [...horarios];
                
                if (excecoes_sex.has(aluno_full_name)) {
                    horarios_disponiveis_aluno = horarios_disponiveis_aluno.filter(h => h !== "Sábado (Manhã)");
                }
                if (excecoes_sab.has(aluno_full_name)) {
                    horarios_disponiveis_aluno = horarios_disponiveis_aluno.filter(h => h !== "Sábado (Manhã)" && h !== "Sábado (Tarde)" && h !== "Domingo (Manhã)");
                }
                if (excecoes_dom.has(aluno_full_name)) {
                    horarios_disponiveis_aluno = horarios_disponiveis_aluno.filter(h => h !== "Domingo (Manhã)" && h !== "Domingo (Tarde)");
                }

                if (horarios_disponiveis_aluno.length === 0) {
                    agenda_final["Próximo Fim de Semana"].push(punicao);
                    continue;
                }
                
                if (punicoes_agendadas_neste_fds >= horarios.length) {
                    agenda_final["Próximo Fim de Semana"].push(punicao);
                    continue;
                }

                let horario_agendado = null;
                for (let i = horario_index; i < horarios.length; i++) {
                    const slot_geral = horarios[i];
                    if (horarios_disponiveis_aluno.includes(slot_geral)) {
                        horario_agendado = slot_geral;
                        horario_index = i + 1;
                        break;
                    }
                }
                
                if (!horario_agendado) {
                    horario_agendado = horarios_disponiveis_aluno[0];
                }
                
                agenda_final[horario_agendado].push(punicao);
                punicoes_agendadas_neste_fds++;
            }

            // Renderiza as tabelas
            statusGeral.textContent = 'Agendamento concluído com sucesso!';
            statusGeral.style.color = '#38A169';
            
            for (const [titulo, punicoes_agendadas] of Object.entries(agenda_final)) {
                if (punicoes_agendadas.length > 0) {
                    outputContainer.innerHTML += buildTableHTML(titulo, punicoes_agendadas);
                }
            }
            if (removidos["PERMUTA"].length > 0) {
                outputContainer.innerHTML += buildRemovidosHTML(removidos["PERMUTA"]);
            }

        } catch (error) {
            console.error('Erro:', error);
            statusGeral.textContent = `Falha no agendamento: ${error.message}`;
            statusGeral.style.color = '#E53E3E';
        }
    }

    function buildTableHTML(titulo, punicoes) {
        let tableHTML = `
            <h3>${titulo}</h3>
            <table class="punishment-table">
                <thead>
                    <tr>
                        <th>RELATÓRIO</th>
                        <th>№</th>
                        <th>ALUNO</th>
                        <th>PLANTÃO</th>
                        <th>PELOTÃO/2° CIA</th>
                        <th>SEI</th>
                        <th>RESUMO</th>
                        <th>ASSINATURA DO ALUNO NO ATO DA CIÊNCIA</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        punicoes.forEach(p => {
            tableHTML += `
                <tr>
                    <td>${p.data_relatorio}</td>
                    <td>${p.n}</td>
                    <td>${p.aluno}</td>
                    <td>${p.plantao}</td>
                    <td>${p.pelotao}</td>
                    <td>${p.sei}</td>
                    <td>${p.resumo}</td>
                    <td></td>
                </tr>
            `;
        });

        tableHTML += `</tbody></table>`;
        return tableHTML;
    }

    function buildRemovidosHTML(removidos) {
        let html = `
            <h3 style="color: #E53E3E;">Alunos Removidos (Permuta)</h3>
            <textarea readonly rows="${removidos.length + 1}">${removidos.join('\n')}</textarea>
        `;
        return html;
    }
</script>

</body>
</html>
